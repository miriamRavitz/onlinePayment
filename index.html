<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>תשלום – שערי צדק</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
 
  <header>
    <img src="HeaderLogo.jpg" alt="שערי צדק" />
  </header>

  <h1 class="page-title">שלום <span id="patientName"></span> 
    <br>תשלום חוב בסך 
    <span id="amount"></span> ש"ח, עבור אשפוז מספר
    <span id="hospitalizationNumber"></span>
    מתאריך <span id="hospDate"></span>
  </h1>

  <div class="form-container" id="formContainer">
    <h2 class="form-title">פרטי משלם</h2>
    <form id="preForm">
      <div class="form-group">
        <label>שם פרטי *</label>
        <input type="text" id="fname" name="fname" required />
      </div>
     
      <div class="form-group">
        <label>שם משפחה *</label>
        <input type="text" id="lname" name="lname" required />
      </div>
     
      <div class="form-group">
        <label>כתובת *</label>
        <input type="text" id="address" name="address" required />
      </div>
     
      <div class="form-group">
        <label>טלפון *</label>
        <input type="tel" id="phone" name="phone" required />
        <div class="error-message" id="phoneError"></div>
      </div>
     
      <div class="form-group">
        <label>אימייל *</label>
        <input type="email" id="email" name="email" required />
      </div>
     
      <button type="submit" class="light-btn">המשך לתשלום</button>
    </form>
  </div>

  <div class="iframe-container" id="iframeContainer" style="display:none;">
    <iframe id="tranzilaFrame" title="טופס תשלום"></iframe>
    <a class="iframe-back-link" onclick="goBackToForm()">← חזרה לעדכון פרטים</a>
  </div>
 
  <footer>
    <img src="FooterLogo.png" alt="שערי צדק" />
  </footer>
 
  <script>
    // קריאת פרמטרים מה-URL
    const params = new URLSearchParams(window.location.search);
    const hosp = params.get('hospitalization') || '';
    const amount = params.get('amount') || '';
    const patientName = params.get('patientName') || '';
    const hospDate = params.get('hospDate') || '';
   
    // הצגת מספר האשפוז בכותרת
    document.getElementById('hospitalizationNumber').textContent = hosp;
    document.getElementById('hospDate').textContent = hospDate;
    document.getElementById('amount').textContent = amount;
    document.getElementById('patientName').textContent = patientName;

    // ניקוי ה-URL אבל שמירת הפרמטרים בזיכרון
    if (history.replaceState) {
      history.replaceState({}, document.title, window.location.pathname);
    }

    const baseUrl = 'https://direct.tranzila.com/szmctest/iframe.php?lang=il&cred type=1&currency=1';
   
    // אזהרה לפני יציאה/רענון - תמיד!
    window.addEventListener('beforeunload', function(e) {
      e.preventDefault();
      e.returnValue = 'האם אתה בטוח שברצונך לעזוב? הקישור יפוג ותצטרך להיכנס מחדש.';
      return e.returnValue;
    });

    // וולידציה על טלפון - מספרים בלבד
    document.getElementById('phone').addEventListener('input', function(e) {
      const phoneError = document.getElementById('phoneError');
      const value = e.target.value;
     
      // הסרת כל תו שאינו מספר
      const onlyNumbers = value.replace(/[^0-9]/g, '');
     
      if (value !== onlyNumbers) {
        e.target.value = onlyNumbers;
      }
     
      if (onlyNumbers.length > 0) {
        e.target.classList.remove('error');
        phoneError.textContent = '';
      }
    });
   
    document.getElementById('preForm').addEventListener('submit', function(e){
      e.preventDefault();
     
      const fname = document.getElementById('fname').value.trim();
      const lname = document.getElementById('lname').value.trim();
      const address = document.getElementById('address').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const phoneError = document.getElementById('phoneError');
     
      // בדיקת שדות חובה
      if(!fname || !lname || !address || !phone || !email) {
        alert('נא למלא את כל השדות החובה');
        return;
      }
     
      // בדיקת טלפון - מספרים בלבד
      if (!/^[0-9]+$/.test(phone)) {
        document.getElementById('phone').classList.add('error');
        phoneError.textContent = 'טלפון חייב להכיל מספרים בלבד';
        alert('נא להכניס מספר טלפון תקין (מספרים בלבד)');
        return;
      }

      // סימון שהתשלום בתהליך
      paymentInProgress = true;
     
      const iframeUrl = `${baseUrl}&sum=${encodeURIComponent(amount)}&hospitalization=${encodeURIComponent(hosp)}&fname=${encodeURIComponent(fname)}&lname=${encodeURIComponent(lname)}&address=${encodeURIComponent(address)}&phone=${encodeURIComponent(phone)}&email=${encodeURIComponent(email)}`;
     
      document.getElementById('tranzilaFrame').src = iframeUrl;
      document.getElementById('iframeContainer').style.display = 'block';
      document.getElementById('formContainer').style.display = 'none';
    });
   
    // פונקציה לחזרה לטופס
    function goBackToForm() {
      document.getElementById('iframeContainer').style.display = 'none';
      document.getElementById('formContainer').style.display = 'block';
      document.getElementById('tranzilaFrame').src = '';
      paymentInProgress = false;
    }

    const requiredFields = [
  { id: 'fname', message: 'נא למלא את השם הפרטי' },
  { id: 'lname', message: 'נא למלא את שם המשפחה' },
  { id: 'address', message: 'נא למלא את הכתובת' },
  { id: 'phone', message: 'נא למלא מספר טלפון תקין' },
  { id: 'email', message: 'נא למלא כתובת אימייל' }
];

requiredFields.forEach(field => {
  const input = document.getElementById(field.id);
  if (!input) return;

  input.oninvalid = function () {
    this.setCustomValidity(field.message);
  };

  input.oninput = function () {
    this.setCustomValidity('');
  };
});
  </script>
</body>
</html>
